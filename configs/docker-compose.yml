# HomeLab SOC Stack - Docker Compose
# Location: /share/Container/SOC/compose/docker-compose.yml
# 
# IMPORTANT: Before running, ensure you've created a .env file with:
#   OPENSEARCH_INITIAL_ADMIN_PASSWORD=YourPasswordHere
#
# Usage:
#   cd /share/Container/SOC/compose
#   docker-compose up -d
#
# To recreate a single service:
#   docker-compose up -d --force-recreate opensearch-dashboards

version: '3.8'

services:
  # =============================================================================
  # OPENSEARCH - SIEM Backend
  # =============================================================================
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - OPENSEARCH_JAVA_OPTS=-Xms2g -Xmx4g
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
    volumes:
      - /share/Container/SOC/containers/opensearch:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"
    networks:
      - soc-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sk https://localhost:9200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # =============================================================================
  # OPENSEARCH DASHBOARDS - Visualization
  # =============================================================================
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: opensearch-dashboards
    restart: unless-stopped
    environment:
      - OPENSEARCH_HOSTS=["https://opensearch:9200"]
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    ports:
      - "5601:5601"
    networks:
      - soc-network
    depends_on:
      opensearch:
        condition: service_healthy

  # =============================================================================
  # SURICATA - Network IDS (SPAN Port Capture)
  # =============================================================================
  # NOTE: Uses host networking to access physical interface eth4
  suricata-live:
    image: jasonish/suricata:latest
    container_name: suricata-live
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    volumes:
      # Logs (persisted)
      - /share/Container/SOC/logs/suricata:/var/log/suricata
      # Config (persisted)
      - /share/Container/SOC/containers/suricata/config:/etc/suricata
      # Rules (persisted - THIS IS THE KEY FIX)
      - /share/Container/SOC/containers/suricata/rules:/var/lib/suricata/rules
      # Rule updates config
      - /share/Container/SOC/containers/suricata/update:/var/lib/suricata/update
    command: -i eth4
    # Note: After first start, run: docker exec suricata-live suricata-update

  # =============================================================================
  # FLUENT BIT - Log Collection & Forwarding
  # =============================================================================
  fluentbit:
    image: fluent/fluent-bit:latest
    container_name: fluentbit
    restart: unless-stopped
    environment:
      - OPENSEARCH_HOST=${OPENSEARCH_HOST:-opensearch}
      - OPENSEARCH_PORT=${OPENSEARCH_PORT:-9200}
      - OPENSEARCH_USER=${OPENSEARCH_USER:-admin}
      - OPENSEARCH_PASS=${OPENSEARCH_PASS}
    volumes:
      - /share/Container/SOC/ingestion/fluentbit:/fluentbit
      - /share/Container/SOC/ingestion/fluentbit/state:/fluentbit/state
      - /share/Container/SOC/logs:/logs:ro
    ports:
      - "5514:5514/tcp"
      - "5514:5514/udp"
    networks:
      - soc-network
    command: /fluent-bit/bin/fluent-bit -c /fluentbit/fluent-bit.conf

  # =============================================================================
  # ZEEK - Network Security Monitor (SPAN Port Capture)
  # =============================================================================
  # NOTE: Uses host networking to access physical interface eth4 (SPAN mirror)
  zeek:
    image: zeek/zeek:latest
    container_name: zeek
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - /share/Container/SOC/logs/zeek:/var/log/zeek
      - /share/Container/SOC/containers/zeek/homelab.zeek:/opt/zeek/homelab.zeek:ro
    working_dir: /var/log/zeek
    command: zeek -i eth4 -C local /opt/zeek/homelab.zeek

  # =============================================================================
  # CYBERCHEF - Data Analysis Tool
  # =============================================================================
  cyberchef:
    image: mpepping/cyberchef:latest
    container_name: cyberchef
    restart: unless-stopped
    ports:
      - "8000:8000"
    networks:
      - soc-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  soc-network:
    driver: bridge
